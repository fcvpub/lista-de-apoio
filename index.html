<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gerador de Lista de Apoios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary mb-4" data-bs-theme="dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Gerador de Listas de Apoio</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link active" target="_blank" href="https://docs.google.com/forms/d/e/1FAIpQLSddyhM7WFswpelRzcdeizi5Ukt_MNbue6YH0JBHIv_hjcJqzA/viewform?usp=publish-editor">Contato</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container-fluid">
    <!-- LISTA INICIAL -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Lista Inicial</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table id="tabela_nomes" class="table table-bordered align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Nome</th>
                <th scope="col">Posso Área</th>
                <th scope="col">Posso Painel</th>
                <th scope="col">Impedido</th>
                <th scope="col">Passou</th>
                <th scope="col">Ações</th>
                <th scope="col">Limpar</th>
              </tr>
            </thead>
            <tbody>
              <tr data-row-id="1" data-number="1">
                <th scope="row">1</th>
                <td><input type="text" class="form-control" placeholder="Nome"></td>
                <td class="text-center">
                  <input class="form-check-input" type="checkbox" name="posso_area_1" value="area">
                </td>
                <td class="text-center">
                  <input class="form-check-input" type="checkbox" name="posso_painel_1" value="painel">
                </td>
                <td class="text-center">
                  <input class="form-check-input" type="radio" name="status_1" value="impedido">
                </td>
                <td class="text-center">
                  <input class="form-check-input" type="radio" name="status_1" value="passou">
                </td>
                <td class="text-center"></td>
                <td class="text-center">
                  <button type="button" class="btn btn-secondary btn-sm btn-limpar">Limpar</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- APOIOS DISPONÍVEIS -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">Apoios Disponíveis</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table id="tabela_apoios" class="table table-bordered align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Dia</th>
                <th scope="col">Grupo</th>
                <th scope="col">Horário</th>
                <th scope="col">Área</th>
                <th scope="col">Painel</th>
                <th scope="col">Ações</th>
                <th scope="col">Limpar</th>
              </tr>
            </thead>
            <tbody>
              <tr data-row-id="1" data-number="1" data-usado="false">
                <th scope="row">1</th>
                <td><input type="text" class="form-control" placeholder="Dia"></td>
                <td>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="grupo_1" id="grupo_1_G1" value="G1">
                    <label class="form-check-label" for="grupo_1_G1">G1</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="grupo_1" id="grupo_1_G2" value="G2">
                    <label class="form-check-label" for="grupo_1_G2">G2</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="grupo_1" id="grupo_1_G3" value="G3">
                    <label class="form-check-label" for="grupo_1_G3">G3</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="grupo_1" id="grupo_1_G4" value="G4">
                    <label class="form-check-label" for="grupo_1_G4">G4</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="grupo_1" id="grupo_1_G5" value="G5">
                    <label class="form-check-label" for="grupo_1_G5">G5</label>
                  </div>
                </td>
                <td>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="horario_1" id="horario_1_07x19" value="07x19">
                    <label class="form-check-label" for="horario_1_07x19">07x19</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="horario_1" id="horario_1_19x07" value="19x07">
                    <label class="form-check-label" for="horario_1_19x07">19x07</label>
                  </div>
                </td>
                <td class="text-center">
                  <input class="form-check-input" type="checkbox" name="area_1" value="area">
                </td>
                <td class="text-center">
                  <input class="form-check-input" type="checkbox" name="painel_1" value="painel">
                </td>
                <td class="text-center"></td>
                <td class="text-center">
                  <button type="button" class="btn btn-secondary btn-sm btn-limpar">Limpar</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Botão GERAR NOVA LISTA -->
    <div class="d-flex justify-content-end mb-4">
      <button id="gerar_nova_lista" type="button" class="btn btn-primary btn-lg">GERAR NOVA LISTA</button>
    </div>
  </main>

  <footer class="bg-light text-center text-muted py-3 mt-4">
    <div class="container-fluid">
      <p class="mb-0">Desenvolvido por <a href="https://github.com/fcvpub" target="_blank" class="text-decoration-none">fcvpub</a> &copy; 2025</p>
    </div>
  </footer>

  <!-- Modal para exibir a lista atualizada -->
  <div class="modal fade" id="modalListaAtualizada" tabindex="-1" aria-labelledby="modalListaAtualizadaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalListaAtualizadaLabel">Lista Atualizada</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <pre><code id="listaCode" class="language-plaintext" style="white-space: pre-wrap; word-wrap: break-word;"></code></pre>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="btnCopiarLista">Copiar</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function() {
      // ---------- FUNÇÃO PARA LIMPAR UMA LINHA ----------
      function limparLinha(linha) {
        linha.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
        linha.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        linha.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
      }

      // ---------- FUNÇÃO AUXILIAR PARA ATUALIZAR BOTÕES (APENAS A COLUNA DE AÇÕES) ----------
      function atualizarBotoes(tbody) {
        const linhas = Array.from(tbody.querySelectorAll('tr'));
        linhas.forEach((linha, index) => {
          const celulaAcoes = linha.querySelector('td:nth-last-child(2)');
          if (!celulaAcoes) return;
          celulaAcoes.innerHTML = '';
          const isUltima = (index === linhas.length - 1);
          if (isUltima) {
            const btnPlus = document.createElement('button');
            btnPlus.type = 'button';
            btnPlus.className = 'btn btn-primary btn-sm btn-plus';
            btnPlus.textContent = '+';
            celulaAcoes.appendChild(btnPlus);
          } else {
            const btnMinus = document.createElement('button');
            btnMinus.type = 'button';
            btnMinus.className = 'btn btn-danger btn-sm btn-minus';
            btnMinus.textContent = '-';
            celulaAcoes.appendChild(btnMinus);
          }
        });
      }

      // ---------- TABELA NOMES ----------
      (function() {
        const tbody = document.querySelector('#tabela_nomes tbody');
        let uniqueId = 2;

        tbody.addEventListener('click', (e) => {
          const target = e.target;
          if (target.classList.contains('btn-plus')) {
            const linhaOrig = target.closest('tr');
            if (!linhaOrig) return;

            const todas = [...tbody.querySelectorAll('tr')];
            const maxNum = todas.reduce((max, linha) => {
              const num = parseInt(linha.dataset.number) || 0;
              return num > max ? num : max;
            }, 0);
            const proxNum = maxNum + 1;
            const novoId = uniqueId++;

            const novaLinha = document.createElement('tr');
            novaLinha.dataset.rowId = novoId;
            novaLinha.dataset.number = proxNum;

            // Coluna #
            const th = document.createElement('th');
            th.scope = 'row';
            th.textContent = proxNum;
            novaLinha.appendChild(th);

            // Nome
            const tdNome = document.createElement('td');
            const inputNome = document.createElement('input');
            inputNome.type = 'text';
            inputNome.className = 'form-control';
            inputNome.value = linhaOrig.querySelector('td:nth-child(2) input')?.value || '';
            tdNome.appendChild(inputNome);
            novaLinha.appendChild(tdNome);

            // Posso Área
            const tdArea = document.createElement('td');
            tdArea.className = 'text-center';
            const cbArea = document.createElement('input');
            cbArea.type = 'checkbox';
            cbArea.className = 'form-check-input';
            cbArea.name = `posso_area_${novoId}`;
            cbArea.value = 'area';
            tdArea.appendChild(cbArea);
            novaLinha.appendChild(tdArea);

            // Posso Painel
            const tdPainel = document.createElement('td');
            tdPainel.className = 'text-center';
            const cbPainel = document.createElement('input');
            cbPainel.type = 'checkbox';
            cbPainel.className = 'form-check-input';
            cbPainel.name = `posso_painel_${novoId}`;
            cbPainel.value = 'painel';
            tdPainel.appendChild(cbPainel);
            novaLinha.appendChild(tdPainel);

            // Impedido
            const tdImpedido = document.createElement('td');
            tdImpedido.className = 'text-center';
            const radioImp = document.createElement('input');
            radioImp.type = 'radio';
            radioImp.className = 'form-check-input';
            radioImp.name = `status_${novoId}`;
            radioImp.value = 'impedido';
            tdImpedido.appendChild(radioImp);
            novaLinha.appendChild(tdImpedido);

            // Passou
            const tdPassou = document.createElement('td');
            tdPassou.className = 'text-center';
            const radioPass = document.createElement('input');
            radioPass.type = 'radio';
            radioPass.className = 'form-check-input';
            radioPass.name = `status_${novoId}`;
            radioPass.value = 'passou';
            tdPassou.appendChild(radioPass);
            novaLinha.appendChild(tdPassou);

            // Coluna de ações (penúltima)
            const tdAcoes = document.createElement('td');
            tdAcoes.className = 'text-center';
            novaLinha.appendChild(tdAcoes);

            // Coluna de limpar (última)
            const tdLimpar = document.createElement('td');
            tdLimpar.className = 'text-center';
            const btnLimpar = document.createElement('button');
            btnLimpar.type = 'button';
            btnLimpar.className = 'btn btn-secondary btn-sm btn-limpar';
            btnLimpar.textContent = 'Limpar';
            tdLimpar.appendChild(btnLimpar);
            novaLinha.appendChild(tdLimpar);

            tbody.appendChild(novaLinha);
            atualizarBotoes(tbody);
          }
          else if (target.classList.contains('btn-minus')) {
            const linha = target.closest('tr');
            if (linha) {
              const tbody = linha.closest('tbody');
              linha.remove();
              atualizarBotoes(tbody);
            }
          }
          else if (target.classList.contains('btn-limpar')) {
            const linha = target.closest('tr');
            if (linha) limparLinha(linha);
          }
        });

        atualizarBotoes(tbody);
      })();

      // ---------- TABELA APOIOS ----------
      (function() {
        const tbody = document.querySelector('#tabela_apoios tbody');
        let uniqueId = 2;

        document.querySelector('#tabela_apoios tbody tr').dataset.usado = 'false';

        tbody.addEventListener('click', (e) => {
          const target = e.target;
          if (target.classList.contains('btn-plus')) {
            const linhaOrig = target.closest('tr');
            if (!linhaOrig) return;

            const todas = [...tbody.querySelectorAll('tr')];
            const maxNum = todas.reduce((max, linha) => {
              const num = parseInt(linha.dataset.number) || 0;
              return num > max ? num : max;
            }, 0);
            const proxNum = maxNum + 1;
            const novoId = uniqueId++;

            const novaLinha = document.createElement('tr');
            novaLinha.dataset.rowId = novoId;
            novaLinha.dataset.number = proxNum;
            novaLinha.dataset.usado = 'false';

            // Coluna #
            const th = document.createElement('th');
            th.scope = 'row';
            th.textContent = proxNum;
            novaLinha.appendChild(th);

            // Dia
            const tdDia = document.createElement('td');
            const inputDia = document.createElement('input');
            inputDia.type = 'text';
            inputDia.className = 'form-control';
            inputDia.value = linhaOrig.querySelector('td:nth-child(2) input')?.value || '';
            tdDia.appendChild(inputDia);
            novaLinha.appendChild(tdDia);

            // Grupo (5 rádios)
            const tdGrupo = document.createElement('td');
            const valoresGrupo = ['G1','G2','G3','G4','G5'];
            valoresGrupo.forEach(g => {
              const div = document.createElement('div');
              div.className = 'form-check';
              const radio = document.createElement('input');
              radio.type = 'radio';
              radio.className = 'form-check-input';
              radio.name = `grupo_${novoId}`;
              radio.value = g;
              radio.id = `grupo_${novoId}_${g}`;
              const label = document.createElement('label');
              label.className = 'form-check-label';
              label.htmlFor = radio.id;
              label.textContent = g;
              div.appendChild(radio);
              div.appendChild(label);
              tdGrupo.appendChild(div);
            });
            novaLinha.appendChild(tdGrupo);

            // Horário (dois rádios)
            const tdHorario = document.createElement('td');
            const horarios = ['07x19','19x07'];
            horarios.forEach(h => {
              const div = document.createElement('div');
              div.className = 'form-check';
              const radio = document.createElement('input');
              radio.type = 'radio';
              radio.className = 'form-check-input';
              radio.name = `horario_${novoId}`;
              radio.value = h;
              radio.id = `horario_${novoId}_${h.replace('x','')}`;
              const label = document.createElement('label');
              label.className = 'form-check-label';
              label.htmlFor = radio.id;
              label.textContent = h;
              div.appendChild(radio);
              div.appendChild(label);
              tdHorario.appendChild(div);
            });
            novaLinha.appendChild(tdHorario);

            // Área (checkbox)
            const tdArea = document.createElement('td');
            tdArea.className = 'text-center';
            const cbArea = document.createElement('input');
            cbArea.type = 'checkbox';
            cbArea.className = 'form-check-input';
            cbArea.name = `area_${novoId}`;
            cbArea.value = 'area';
            tdArea.appendChild(cbArea);
            novaLinha.appendChild(tdArea);

            // Painel (checkbox)
            const tdPainel = document.createElement('td');
            tdPainel.className = 'text-center';
            const cbPainel = document.createElement('input');
            cbPainel.type = 'checkbox';
            cbPainel.className = 'form-check-input';
            cbPainel.name = `painel_${novoId}`;
            cbPainel.value = 'painel';
            tdPainel.appendChild(cbPainel);
            novaLinha.appendChild(tdPainel);

            // Coluna de ações (penúltima)
            const tdAcoes = document.createElement('td');
            tdAcoes.className = 'text-center';
            novaLinha.appendChild(tdAcoes);

            // Coluna de limpar (última)
            const tdLimpar = document.createElement('td');
            tdLimpar.className = 'text-center';
            const btnLimpar = document.createElement('button');
            btnLimpar.type = 'button';
            btnLimpar.className = 'btn btn-secondary btn-sm btn-limpar';
            btnLimpar.textContent = 'Limpar';
            tdLimpar.appendChild(btnLimpar);
            novaLinha.appendChild(tdLimpar);

            tbody.appendChild(novaLinha);
            atualizarBotoes(tbody);
          }
          else if (target.classList.contains('btn-minus')) {
            const linha = target.closest('tr');
            if (linha) {
              const tbody = linha.closest('tbody');
              linha.remove();
              atualizarBotoes(tbody);
            }
          }
          else if (target.classList.contains('btn-limpar')) {
            const linha = target.closest('tr');
            if (linha) limparLinha(linha);
          }
        });

        atualizarBotoes(tbody);
      })();

      // ---------- BOTÃO GERAR LISTA ATUALIZADA ----------
      document.getElementById('gerar_nova_lista').addEventListener('click', function(e) {
        e.preventDefault();

        // ---------- MATRIZ NOMES (apenas para console) ----------
        const linhasNomes = document.querySelectorAll('#tabela_nomes tbody tr');
        const matrizNomes = [];
        linhasNomes.forEach(linha => {
          const nome = linha.querySelector('td:nth-child(2) input')?.value || '';
          const possoArea = linha.querySelector('td:nth-child(3) input[type="checkbox"]')?.checked || false;
          const possoPainel = linha.querySelector('td:nth-child(4) input[type="checkbox"]')?.checked || false;
          const impedido = linha.querySelector('td:nth-child(5) input[type="radio"]:checked')?.value === 'impedido';
          const passou = linha.querySelector('td:nth-child(6) input[type="radio"]:checked')?.value === 'passou';
          matrizNomes.push([nome, possoArea, possoPainel, impedido, passou]);
        });
        console.log('=== Matriz Nomes (Nome, Posso Área, Posso Painel, Impedido, Passou) ===');
        console.log(matrizNomes);

        // ---------- MATRIZ APOIOS (apenas para console) ----------
        const linhasApoios = document.querySelectorAll('#tabela_apoios tbody tr');
        const matrizApoios = [];
        linhasApoios.forEach(linha => {
          const dia = linha.querySelector('td:nth-child(2) input')?.value || '';
          const grupoRadio = linha.querySelector('td:nth-child(3) input[type="radio"]:checked');
          const grupo = grupoRadio ? grupoRadio.value : '';
          const horarioRadio = linha.querySelector('td:nth-child(4) input[type="radio"]:checked');
          const horario = horarioRadio ? horarioRadio.value : '';
          const area = linha.querySelector('td:nth-child(5) input[type="checkbox"]')?.checked || false;
          const painel = linha.querySelector('td:nth-child(6) input[type="checkbox"]')?.checked || false;
          const usado = linha.dataset.usado === 'true';
          matrizApoios.push([dia, grupo, horario, area, painel, usado]);
        });
        console.log('=== Matriz Apoios (Dia, Grupo, Horário, Área, Painel, Usado) ===');
        console.log(matrizApoios);

        // ---------- LISTA ATUALIZADA (NOVA LÓGICA) ----------
        // Reseta usado
        linhasApoios.forEach(linha => linha.dataset.usado = 'false');

        // Array de nomes com dados
        const nomes = [];
        linhasNomes.forEach(linha => {
          const nome = linha.querySelector('td:nth-child(2) input')?.value || '(sem nome)';
          const possoArea = linha.querySelector('td:nth-child(3) input[type="checkbox"]')?.checked || false;
          const possoPainel = linha.querySelector('td:nth-child(4) input[type="checkbox"]')?.checked || false;
          const impedido = linha.querySelector('td:nth-child(5) input[type="radio"]:checked')?.value === 'impedido';
          const passou = linha.querySelector('td:nth-child(6) input[type="radio"]:checked')?.value === 'passou';
          nomes.push({ nome, possoArea, possoPainel, impedido, passou });
        });

        const totalNomes = nomes.length;
        // Lista com o dobro de posições, preenchida com traços
        const lista = new Array(2 * totalNomes).fill('-');
        // Preenche as primeiras posições com os nomes (apenas nome)
        for (let i = 0; i < totalNomes; i++) {
          lista[i] = nomes[i].nome;
        }
        let fim = totalNomes; // primeira posição vaga (índice)

        // Processa cada nome na ordem original
        for (let i = 0; i < totalNomes; i++) {
          const item = nomes[i];
          if (item.impedido) {
            lista[i] = `${item.nome} - Impedido`;
          } else if (item.passou) {
            lista[fim] = `${item.nome} - Passou`;
            lista[i] = '-';
            fim++;
          } else if (item.possoArea || item.possoPainel) {
            // Procura apoio compatível não usado
            let apoioEncontrado = null;
            for (let apoioLinha of linhasApoios) {
              if (apoioLinha.dataset.usado === 'true') continue;
              const apoioArea = apoioLinha.querySelector('td:nth-child(5) input[type="checkbox"]')?.checked || false;
              const apoioPainel = apoioLinha.querySelector('td:nth-child(6) input[type="checkbox"]')?.checked || false;
              if ((item.possoArea && apoioArea) || (item.possoPainel && apoioPainel)) {
                apoioEncontrado = apoioLinha;
                break;
              }
            }
            if (apoioEncontrado) {
              apoioEncontrado.dataset.usado = 'true';
              const dia = apoioEncontrado.querySelector('td:nth-child(2) input')?.value || '';
              const grupoRadio = apoioEncontrado.querySelector('td:nth-child(3) input[type="radio"]:checked');
              const grupo = grupoRadio ? grupoRadio.value : '';
              const horarioRadio = apoioEncontrado.querySelector('td:nth-child(4) input[type="radio"]:checked');
              const horario = horarioRadio ? horarioRadio.value : '';
              lista[fim] = `${item.nome} - ${dia} - ${grupo} - ${horario}`;
              lista[i] = '-';
              fim++;
            } else {
              // Não encontrou apoio: mantém apenas o nome na posição original
              // (lista[i] já está com item.nome)
            }
          } else {
            // Sem interesse e não impedido/passou: mantém apenas o nome
            // (lista[i] já está com item.nome)
          }
        }

        // Remove todos os traços
        const listaFinal = lista.filter(item => item !== '-');

        console.log('=== LISTA ATUALIZADA ===');
        console.log(listaFinal);

        // Formata a data atual como dd/mm
        const hoje = new Date();
        const dia = String(hoje.getDate()).padStart(2, '0');
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const dataFormatada = `${dia}/${mes}`;

        // Atualiza o título do modal
        document.getElementById('modalListaAtualizadaLabel').textContent = `Lista Atualizada em: ${dataFormatada}\n`;

        // Exibe no modal
        const textoLista = listaFinal.join('\n');
        document.getElementById('listaCode').textContent = textoLista;
        const modal = new bootstrap.Modal(document.getElementById('modalListaAtualizada'));
        modal.show();
      });
    })();
  </script>

  <!-- Script para o botão Copiar -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('btnCopiarLista').addEventListener('click', function() {
      const titulo = document.getElementById('modalListaAtualizadaLabel').textContent;
      const lista = document.getElementById('listaCode').textContent;
      const textoCompleto = titulo + '\n' + lista;
      navigator.clipboard.writeText(textoCompleto).then(() => {
        alert('Lista copiada para a área de transferência!');
      }).catch(err => {
        console.error('Erro ao copiar: ', err);
      });
    });
  });
</script>

</body>
</html>